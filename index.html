<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Calculadora Forense - Newton</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
    margin:0;
    min-height:100vh;
    background:linear-gradient(rgba(0,0,0,.65),rgba(0,0,0,.65)),
    url("https://balancemexico.com/wp-content/uploads/2023/10/img_3580-1.jpg")
    no-repeat center center fixed;
    background-size:cover;
    font-family:Arial;
    color:white;
    display:flex;
    justify-content:center;
    align-items:center;
}
.contenedor{
    background:rgba(31,42,56,.95);
    padding:25px;
    border-radius:14px;
    width:95%;
    max-width:440px;
}
label{margin-top:12px;display:block;font-weight:bold;}
input,button{
    width:100%;
    padding:8px;
    margin-top:5px;
    border-radius:6px;
    border:none;
}
button{
    background:#c0392b;
    color:white;
    font-size:16px;
    cursor:pointer;
}
button:hover{background:#e74c3c;}
.resultado{
    margin-top:20px;
    padding:15px;
    background:rgba(0,0,0,.35);
    display:none;
    border-left:4px solid #e74c3c;
}
canvas{
    background:white;
    border-radius:8px;
    margin-top:10px;
}
</style>
</head>

<body>
<div class="contenedor">
<h2>Calculadora Forense</h2>

<label>Temperatura corporal 1 (°C)</label>
<input type="number" id="T1">

<label>Temperatura corporal 2 (°C)</label>
<input type="number" id="T2">

<label>Tiempo entre mediciones (minutos)</label>
<input type="number" id="dt">

<label>Temperatura ambiente (°C)</label>
<input type="number" id="Ta">

<label>Hora en que se encontró el cuerpo</label>
<input type="time" id="horaHallazgo">

<button onclick="calcular()">Calcular</button>

<div class="resultado" id="resultado">
<p id="horaHall"></p>
<p id="tiempoMuerte"></p>
<p id="tiempoEntre"></p>
<p id="horaMuerte"></p>
<p id="texto"></p>
<canvas id="grafica"></canvas>
</div>
</div>

<script>
let chart;

function $(id){ return document.getElementById(id); }

function toNum(id){
  const v=parseFloat($(id).value);
  if(Number.isNaN(v)) throw new Error(`El campo ${id} es inválido`);
  return v;
}

function calcularHoraDeMuerte(horaHallazgo, tiempoDesdeMuerte){
  const [h,m]=horaHallazgo.split(":").map(Number);
  let totalMin=h*60+m-tiempoDesdeMuerte;
  if(totalMin<0) totalMin+=1440;

  const hh=Math.floor(totalMin/60);
  const mm=Math.round(totalMin%60);
  const ampm=hh>=12?"PM":"AM";
  const h12=hh%12||12;

  return `${h12}:${mm.toString().padStart(2,"0")} ${ampm}`;
}

function calcularNewton(Ta,T0,t1,T1,t2,T2){
  const C=T1-Ta;
  const k=-(1/(t2-t1))*Math.log((T2-Ta)/C);
  return (1/k)*Math.log((T0-Ta)/C); // minutos
}

function calcular(){
  try{
    const T1=toNum("T1");
    const T2=toNum("T2");
    const dt=toNum("dt");
    const Ta=toNum("Ta");
    const horaHallazgo=$("horaHallazgo").value;
    if(!horaHallazgo) throw new Error("Ingresa la hora de hallazgo");

    const tiempoDesdeMuerte=calcularNewton(Ta,37,0,T1,dt,T2);

    // ✅ FORMATO CORRECTO DE TIEMPO
    let tiempoTexto="";
    if(tiempoDesdeMuerte<60){
      tiempoTexto=`${tiempoDesdeMuerte.toFixed(0)} minutos`;
    }else{
      tiempoTexto=`${(tiempoDesdeMuerte/60).toFixed(2)} horas`;
    }

    horaHall.innerHTML=` <b>Hora de hallazgo:</b> ${horaHallazgo}`;
    tiempoMuerte.innerHTML=` <b>Tiempo desde la muerte:</b> ${tiempoTexto}`;
    tiempoEntre.innerHTML=` <b>Tiempo entre mediciones:</b> ${dt} minutos`;
    horaMuerte.innerHTML=` <b>Hora estimada de la muerte:</b> ${calcularHoraDeMuerte(horaHallazgo,tiempoDesdeMuerte)}`;

    texto.innerHTML=`El cálculo se realizó usando la Ley de Enfriamiento de Newton 
    con dos mediciones de temperatura corporal y la temperatura ambiente.`;

    dibujarGrafica(Ta,37,tiempoDesdeMuerte);
    resultado.style.display="block";
  }catch(e){
    alert(e.message);
  }
}

function dibujarGrafica(Ta,T0,tiempo){
  let labels=[],data=[];
  const k=0.01;
  for(let t=0;t<=tiempo+30;t+=5){
    labels.push((t/60).toFixed(2));
    data.push(Ta+(T0-Ta)*Math.exp(-k*t));
  }
  if(chart) chart.destroy();
  chart=new Chart(grafica,{
    type:"line",
    data:{labels,datasets:[{label:"Temperatura corporal (°C)",data,fill:false,borderColor:"red"}]}
  });
}
</script>
</body>
</html>


